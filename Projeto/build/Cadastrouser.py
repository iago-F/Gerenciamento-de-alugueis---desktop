
# This file was generated by the Tkinter Designer by Parth Jadhav
# https://github.com/ParthJadhav/Tkinter-Designer


# from tkinter import *
# Explicit imports to satisfy Flake8

import tkinter as tk
from tkinter import messagebox

from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from Projeto.build.models.models import User,Casa
from connection import engine

Base = declarative_base()

Session = sessionmaker(bind=engine)
session = Session()

# Funções






# Deletar usuário 
            
def excluir_usuario(usuario_id):
    try:
        # Consulta o usuário no banco de dados pelo ID
        usuario = session.query(User).filter_by(id=usuario_id).first()

        # Verifica se o usuário foi encontrado
        if usuario:
            # Consulta todas as casas associadas ao usuário
            casas = session.query(Casa).filter_by(usuario_id=usuario_id).all()

            # Remove todas as casas associadas ao usuário
            for casa in casas:
                session.delete(casa)

            # Remove o usuário do banco de dados
            session.delete(usuario)
            session.commit()

            # Exibe uma mensagem de sucesso
            print("Usuário e todas as suas casas foram excluídos com sucesso!")
        else:
            # Exibe uma mensagem de erro se o usuário não foi encontrado
            print("Usuário não encontrado.")
    except Exception as e:
        # Em caso de erro, desfaz a transação
        session.rollback()
        
        # Exibe uma mensagem de erro
        print(f"Erro ao excluir usuário: {str(e)}")



#Pegar o usuário autenticado.
def ObterUsuarioAutenticado(nome):
    # Realiza uma consulta para encontrar o usuário autenticado com base no nome de usuário
    usuario = session.query(User).filter_by(nome_de_usuario=nome).first()
    if usuario:
        return usuario.id
    else:
        return None

class CadastroWindow:
    def __init__(self, root):
        self.root = root
        self.root.title("Cadastro de Usuário")
        self.root.geometry("550x350")  # Ajustado o tamanho da tela
        self.root.config(bg="white")  # Define o fundo da tela como branco

        # Criar um frame para centralizar o conteúdo
        self.frame = tk.Frame(root, bg="white")
        self.frame.pack(expand=True, fill=tk.BOTH)

        # Adiciona o título
        self.titulo = tk.Label(self.frame, text="Cadastrar Usuário", font=('Arial', 16, 'bold'), bg="white")
        self.titulo.grid(row=0, column=0, columnspan=2, pady=10)

        # Labels e Entradas
        self.label_nome = tk.Label(self.frame, text="Nome:", bg="white")
        self.label_nome.grid(row=1, column=0, padx=10, pady=5, sticky="e")

        self.input_nome = tk.Entry(self.frame, bg="lightgrey")
        self.input_nome.grid(row=1, column=1, padx=10, pady=5)

        self.label_sobrenome = tk.Label(self.frame, text="Sobrenome:", bg="white")
        self.label_sobrenome.grid(row=2, column=0, padx=10, pady=5, sticky="e")

        self.input_sobrenome = tk.Entry(self.frame, bg="lightgrey")
        self.input_sobrenome.grid(row=2, column=1, padx=10, pady=5)

        self.label_cpf = tk.Label(self.frame, text="CPF:", bg="white")
        self.label_cpf.grid(row=3, column=0, padx=10, pady=5, sticky="e")

        self.input_cpf = tk.Entry(self.frame, bg="lightgrey")
        self.input_cpf.grid(row=3, column=1, padx=10, pady=5)

        self.label_email = tk.Label(self.frame, text="Email:", bg="white")
        self.label_email.grid(row=4, column=0, padx=10, pady=5, sticky="e")

        self.input_email = tk.Entry(self.frame, bg="lightgrey")
        self.input_email.grid(row=4, column=1, padx=10, pady=5)

        self.label_senha = tk.Label(self.frame, text="Senha:", bg="white")
        self.label_senha.grid(row=5, column=0, padx=10, pady=5, sticky="e")

        self.input_senha = tk.Entry(self.frame, show="*", bg="lightgrey")
        self.input_senha.grid(row=5, column=1, padx=10, pady=5)

        # Botão de cadastro
        self.botao_cadastrar = tk.Button(self.frame, text="Cadastrar", command=self.cadastrar_usuario, bg="lightblue")
        self.botao_cadastrar.grid(row=6, column=0, columnspan=2, pady=20)

    def cadastrar_usuario(self):
        session = Session()
        nome = self.input_nome.get()
        sobrenome = self.input_sobrenome.get()
        cpf = self.input_cpf.get()
        email = self.input_email.get()
        senha = self.input_senha.get()

        try:
            if cpf and email:
                # Cria uma instância de Usuario com os dados inseridos pelo usuário
                usuario = User(nome=nome, sobreNome=sobrenome, cpf=cpf, email=email, senha=senha)

                # Adiciona o usuário ao banco de dados
                session.add(usuario)

                # Confirma a transação
                session.commit()

                # Exibe uma mensagem de sucesso
                messagebox.showinfo("Sucesso", "Usuário cadastrado com sucesso!")
            else:
                # Exibe um aviso se algum campo estiver vazio
                print("Por favor, preencha todos os campos.")
        finally:
            # Fecha a sessão do SQLAlchemy
            session.close()


    def criar_tabela_usuario():
        Base.metadata.create_all(engine)

    def Abrir_janela_cadastro():

        root_login.destroy()
        root_cadastro = tk.Tk()
        app_cadastro = CadastroWindow(root_cadastro)
        root.destroy()


if __name__ == "__main__":
    root_login = tk.Tk()
    root_login.title("Login")
    root = tk.Tk()
